<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow AI - Güvenli Giriş</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(90deg, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .loader { border-top-color: #818cf8; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #recaptcha-container { margin: 15px 0; display: flex; justify-content: center; min-height: 80px; }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden">

    <!-- Auth Ekranı -->
    <div id="auth-screen" class="flex items-center justify-center min-h-screen">
        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold gradient-text">StudyFlow AI</h1>
                <p class="text-gray-400 mt-2">Ders çalışmanın en akıllı yolu</p>
            </div>

            <!-- Adım 1: Telefon Numarası -->
            <div id="phone-input-container" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Telefon Numaranız (Uluslararası Format)</label>
                    <input type="tel" id="phone-number" placeholder="+905554443322" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:outline-none focus:border-indigo-500 text-white text-lg">
                    <p class="text-[10px] text-gray-500 mt-1">* Örn: +905XXXXXXXXX</p>
                </div>
                
                <div id="recaptcha-container"></div>

                <button id="send-code-btn" onclick="sendOTP()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition duration-300 flex items-center justify-center gap-2">
                    <i data-lucide="send" class="w-5 h-5"></i>
                    Doğrulama Kodu Gönder
                </button>
            </div>

            <!-- Adım 2: Doğrulama Kodu -->
            <div id="otp-input-container" class="hidden space-y-4">
                <div class="text-center">
                    <p class="text-sm text-indigo-400 mb-4" id="sent-number-info"></p>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">SMS Doğrulama Kodu</label>
                    <input type="text" id="verification-code" placeholder="6 Haneli Kod" maxlength="6" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:outline-none focus:border-indigo-500 tracking-[0.5em] text-center text-xl font-bold text-white">
                </div>
                <button id="verify-code-btn" onclick="verifyOTP()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl transition duration-300 flex items-center justify-center gap-2">
                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                    Kodu Doğrula ve Giriş Yap
                </button>
                <button onclick="resetAuthUI()" class="w-full text-sm text-gray-500 hover:text-gray-300 underline pt-2">Numarayı Değiştir</button>
            </div>
            
            <div id="auth-error" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500/50 text-red-400 text-xs rounded-lg text-center leading-relaxed"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-screen" class="hidden min-h-screen">
        <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center border-b border-white/5">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-2 rounded-lg">
                    <i data-lucide="graduation-cap" class="text-white w-6 h-6"></i>
                </div>
                <span class="text-xl font-bold gradient-text">StudyFlow AI</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="showModal('add-task-modal')" class="bg-indigo-600/20 text-indigo-400 border border-indigo-500/30 px-4 py-2 rounded-lg hover:bg-indigo-600 hover:text-white transition duration-200 flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Yeni Ders Ekle
                </button>
                <button onclick="handleLogout()" class="text-gray-400 hover:text-white"><i data-lucide="log-out"></i></button>
            </div>
        </nav>

        <main class="container mx-auto px-4 py-8">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <i data-lucide="calendar" class="text-indigo-400"></i> Çalışma Programım
            </h2>
            <div id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full py-20 text-center text-gray-500 italic" id="no-tasks">
                    Henüz bir ders eklemediniz.
                </div>
            </div>
        </main>
    </div>

    <!-- Çalışma Modülü -->
    <div id="study-mode" class="hidden fixed inset-0 z-[60] bg-slate-950 flex flex-col md:flex-row">
        <div class="flex-1 relative bg-black flex items-center justify-center">
            <button onclick="exitStudyMode()" class="absolute top-4 left-4 z-10 bg-black/50 text-white p-2 rounded-full hover:bg-white/20">
                <i data-lucide="arrow-left"></i>
            </button>
            <div id="video-container" class="w-full aspect-video max-h-screen"></div>
        </div>
        <div class="w-full md:w-[400px] lg:w-[500px] glass h-full flex flex-col border-l border-white/10">
            <div class="p-6 border-b border-white/10">
                <h3 id="study-title" class="text-xl font-bold text-indigo-400">Ders Başlığı</h3>
                <p id="study-date" class="text-sm text-gray-500"></p>
            </div>
            <div id="ai-content" class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-4">
                <div class="flex items-center gap-2 text-purple-400 font-semibold mb-2">
                    <i data-lucide="sparkles" class="w-5 h-5"></i> AI Konu Özeti
                </div>
                <div id="ai-summary-text" class="text-gray-300 leading-relaxed text-sm whitespace-pre-wrap"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="add-task-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="glass p-8 rounded-2xl w-full max-w-lg shadow-2xl relative">
            <button onclick="closeModal('add-task-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x"></i>
            </button>
            <h3 class="text-2xl font-bold mb-6">Ders Planla</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Ders veya Konu Adı</label>
                    <input type="text" id="task-name" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">YouTube Video Linki</label>
                    <input type="text" id="task-url" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Tarih</label>
                    <input type="date" id="task-date" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:outline-none focus:border-indigo-500">
                </div>
                <button id="save-task-btn" onclick="saveTask()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition duration-300 flex items-center justify-center gap-2">
                    <span id="btn-text">Ders Programına Ekle</span>
                    <div id="btn-loader" class="hidden loader w-5 h-5 border-2 rounded-full"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'studyflow-ai-001';

        let currentUser = null;
        let tasks = [];
        let taskUnsubscribe = null;
        let confirmationResult = null;
        let recaptchaVerifier = null;

        // Oturum Durumu Takibi
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                loadTasks(user.uid);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('dashboard-screen').classList.add('hidden');
                if (taskUnsubscribe) taskUnsubscribe();
            }
            lucide.createIcons();
        });

        // reCAPTCHA'yı sadece ihtiyaç duyulduğunda oluştur (Fix: auth/internal-error)
        const setupRecaptcha = async () => {
            try {
                if (recaptchaVerifier) {
                    await recaptchaVerifier.clear();
                    recaptchaVerifier = null;
                }
                
                recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'normal',
                    'callback': (response) => {
                        console.log("reCAPTCHA doğrulandı");
                    },
                    'expired-callback': () => {
                        showError("reCAPTCHA süresi doldu.");
                    }
                });
                
                return await recaptchaVerifier.render();
            } catch (error) {
                console.error("reCAPTCHA Setup Error:", error);
                throw error;
            }
        };

        // SMS Kodu Gönder
        window.sendOTP = async () => {
            const phoneNumber = document.getElementById('phone-number').value.trim();
            const btn = document.getElementById('send-code-btn');
            
            if (!phoneNumber.startsWith('+')) {
                showError("Telefon numarası '+' ile başlamalı (Örn: +90...)");
                return;
            }

            try {
                btn.disabled = true;
                btn.textContent = "Hazırlanıyor...";
                hideError();

                // reCAPTCHA'yı gönderim anında kur
                await setupRecaptcha();

                btn.textContent = "Kod Gönderiliyor...";
                confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
                
                document.getElementById('phone-input-container').classList.add('hidden');
                document.getElementById('otp-input-container').classList.remove('hidden');
                document.getElementById('sent-number-info').textContent = `${phoneNumber} numarasına kod gönderildi.`;
            } catch (error) {
                console.error("SMS Gönderme Hatası:", error);
                let message = "SMS gönderilemedi. Lütfen numaranızı veya internetinizi kontrol edin.";
                if (error.code === 'auth/internal-error') message = "reCAPTCHA başlatılamadı. Lütfen sayfayı yenileyip tekrar deneyin.";
                if (error.code === 'auth/too-many-requests') message = "Çok fazla deneme. Lütfen biraz bekleyin.";
                
                showError(message + " (" + error.code + ")");
                btn.disabled = false;
                btn.textContent = "Doğrulama Kodu Gönder";
                if (recaptchaVerifier) {
                    recaptchaVerifier.clear();
                    recaptchaVerifier = null;
                }
            }
        };

        // SMS Kodu Doğrula
        window.verifyOTP = async () => {
            const code = document.getElementById('verification-code').value.trim();
            const btn = document.getElementById('verify-code-btn');

            if (code.length !== 6) {
                showError("Lütfen 6 haneli kodu girin.");
                return;
            }

            try {
                btn.disabled = true;
                btn.textContent = "Doğrulanıyor...";
                await confirmationResult.confirm(code);
            } catch (error) {
                showError("Hatalı kod girdiniz.");
                btn.disabled = false;
                btn.textContent = "Kodu Doğrula ve Giriş Yap";
            }
        };

        window.resetAuthUI = () => {
            document.getElementById('phone-input-container').classList.remove('hidden');
            document.getElementById('otp-input-container').classList.add('hidden');
            hideError();
            document.getElementById('send-code-btn').disabled = false;
            document.getElementById('send-code-btn').textContent = "Doğrulama Kodu Gönder";
        };

        function showError(msg) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = msg;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('auth-error').classList.add('hidden');
        }

        window.handleLogout = async () => {
            await signOut(auth);
            location.reload();
        };

        // Firestore İşlemleri
        function loadTasks(userId) {
            if (taskUnsubscribe) taskUnsubscribe();
            const tasksRef = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
            taskUnsubscribe = onSnapshot(tasksRef, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks();
            });
        }

        async function getAISummary(topicName) {
            const apiKey = "";
            const prompt = `Lütfen "${topicName}" konulu bir ders için detaylı, maddeler halinde Türkçe bir çalışma özeti hazırla.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Özet hazır.";
            } catch (e) { return "AI şu an meşgul."; }
        }

        window.saveTask = async () => {
            if (!currentUser) return;
            const name = document.getElementById('task-name').value;
            const url = document.getElementById('task-url').value;
            const date = document.getElementById('task-date').value;
            if (!name || !url) return;

            const btn = document.getElementById('save-task-btn');
            btn.disabled = true;
            document.getElementById('btn-loader').classList.remove('hidden');
            document.getElementById('btn-text').textContent = "AI Hazırlanıyor...";

            const aiSummary = await getAISummary(name);

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks'), {
                    name, youtubeUrl: url, date: date || new Date().toISOString().split('T')[0],
                    aiSummary, createdAt: Date.now()
                });
                closeModal('add-task-modal');
                document.getElementById('task-name').value = "";
                document.getElementById('task-url').value = "";
            } catch (err) { console.error(err); } finally {
                btn.disabled = false;
                document.getElementById('btn-loader').classList.add('hidden');
                document.getElementById('btn-text').textContent = "Ders Programına Ekle";
            }
        };

        window.deleteTask = async (id) => {
            if(confirm("Dersi silmek istiyor musunuz?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks', id));
            }
        };

        function extractVideoId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            const noTasks = document.getElementById('no-tasks');
            list.innerHTML = "";
            if (tasks.length === 0) { noTasks.classList.remove('hidden'); return; }
            noTasks.classList.add('hidden');

            [...tasks].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(task => {
                const videoId = extractVideoId(task.youtubeUrl);
                const thumb = videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : '';
                const card = document.createElement('div');
                card.className = "glass rounded-2xl overflow-hidden shadow-lg border border-white/5";
                card.innerHTML = `
                    <div class="relative h-44">
                        <img src="${thumb}" class="w-full h-full object-cover opacity-50">
                        <button onclick="startStudy('${task.id}')" class="absolute inset-0 m-auto bg-indigo-600 hover:bg-indigo-500 p-4 rounded-full w-fit h-fit shadow-xl"><i data-lucide="play" class="fill-white text-white"></i></button>
                    </div>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-bold text-lg leading-tight">${task.name}</h4>
                            <button onclick="deleteTask('${task.id}')" class="text-gray-600 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4 text-indigo-500"></i>${task.date}</p>
                        <button onclick="startStudy('${task.id}')" class="w-full py-2.5 bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400 rounded-xl text-sm font-semibold transition">Çalışmaya Başla</button>
                    </div>`;
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        window.startStudy = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            const videoId = extractVideoId(task.youtubeUrl);
            document.getElementById('video-container').innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            document.getElementById('study-title').textContent = task.name;
            document.getElementById('study-date').textContent = task.date;
            document.getElementById('ai-summary-text').textContent = task.aiSummary;
            document.getElementById('study-mode').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        };

        window.exitStudyMode = () => {
            document.getElementById('study-mode').classList.add('hidden');
            document.getElementById('video-container').innerHTML = "";
            document.body.style.overflow = 'auto';
        };

        window.showModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    </script>
</body>
</html>
