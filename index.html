<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow AI - E-Posta ile Giriş ve Çoklu Konu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(90deg, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .loader { border-top-color: #818cf8; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden">

    <!-- Auth Ekranı -->
    <div id="auth-screen" class="flex items-center justify-center min-h-screen">
        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold gradient-text">StudyFlow AI</h1>
                <p class="text-gray-400 mt-2">Ders çalışmanın en akıllı yolu</p>
            </div>

            <div id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">E-Posta Adresiniz</label>
                    <input type="email" id="auth-email" placeholder="ornek@email.com" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:outline-none focus:border-indigo-500 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Şifreniz</label>
                    <input type="password" id="auth-password" placeholder="••••••••" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:outline-none focus:border-indigo-500 text-white">
                </div>
                
                <div class="flex flex-col gap-3 pt-2">
                    <button onclick="handleLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition duration-300 flex items-center justify-center gap-2">
                        Giriş Yap
                    </button>
                    <button onclick="handleSignup()" class="w-full bg-white/5 hover:bg-white/10 text-indigo-400 font-medium py-3 rounded-xl border border-white/10 transition flex items-center justify-center gap-2">
                        Yeni Hesap Oluştur
                    </button>
                </div>
            </div>
            
            <div id="auth-error" class="hidden mt-4 p-3 bg-red-500/10 border border-red-500/20 text-red-400 text-xs rounded-lg text-center"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-screen" class="hidden min-h-screen">
        <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center border-b border-white/5">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-2 rounded-lg">
                    <i data-lucide="graduation-cap" class="text-white w-6 h-6"></i>
                </div>
                <span class="text-xl font-bold gradient-text">StudyFlow AI</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="showModal('add-course-modal')" class="bg-indigo-600/20 text-indigo-400 border border-indigo-500/30 px-4 py-2 rounded-lg hover:bg-indigo-600 hover:text-white transition duration-200 flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Yeni Ders Ekle
                </button>
                <button onclick="handleLogout()" class="text-gray-400 hover:text-white"><i data-lucide="log-out"></i></button>
            </div>
        </nav>

        <main class="container mx-auto px-4 py-8">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <i data-lucide="book-open" class="text-indigo-400"></i> Derslerim
            </h2>
            <div id="course-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Dersler buraya gelecek -->
                <div class="col-span-full py-20 text-center text-gray-500 italic" id="no-courses">
                    Henüz bir ders eklemediniz. "Yeni Ders Ekle" butonuna basın.
                </div>
            </div>
        </main>
    </div>

    <!-- Çalışma Modülü -->
    <div id="study-mode" class="hidden fixed inset-0 z-[60] bg-slate-950 flex flex-col md:flex-row">
        <div class="flex-1 relative bg-black flex flex-col items-center justify-center p-4">
            <button onclick="exitStudyMode()" class="absolute top-4 left-4 z-10 bg-black/50 text-white p-2 rounded-full hover:bg-white/20 transition-all">
                <i data-lucide="arrow-left"></i>
            </button>
            <div id="video-container" class="w-full aspect-video max-w-5xl shadow-2xl rounded-xl overflow-hidden border border-white/10"></div>
            <div id="topic-nav" class="mt-6 flex gap-2 overflow-x-auto p-2 w-full max-w-5xl">
                <!-- Konu navigasyon butonları -->
            </div>
        </div>
        <div class="w-full md:w-[400px] lg:w-[450px] glass h-full flex flex-col border-l border-white/10 shadow-2xl">
            <div class="p-6 border-b border-white/10">
                <h3 id="study-course-title" class="text-xl font-bold text-indigo-400">Ders İsmi</h3>
                <p id="study-topic-title" class="text-sm text-gray-400 mt-1">Konu Başlığı</p>
            </div>
            <div id="ai-content" class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-4">
                <div class="flex items-center gap-2 text-purple-400 font-semibold mb-2">
                    <i data-lucide="sparkles" class="w-5 h-5"></i> AI Ders Notları & Özet
                </div>
                <div id="ai-summary-text" class="text-gray-300 leading-relaxed text-sm whitespace-pre-wrap"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Yeni Ders Ekle -->
    <div id="add-course-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="glass p-8 rounded-2xl w-full max-w-2xl shadow-2xl relative max-h-[90vh] flex flex-col">
            <button onclick="closeModal('add-course-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            <h3 class="text-2xl font-bold mb-6">Ders Planla</h3>
            
            <div class="space-y-6 overflow-y-auto pr-2 custom-scrollbar flex-1">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Ders Adı</label>
                    <input type="text" id="course-name" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:outline-none focus:border-indigo-500" placeholder="Örn: Modern Fizik">
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-sm text-gray-400">Ders İçeriği & Konular</label>
                        <button onclick="addTopicField()" class="text-xs bg-indigo-600/20 text-indigo-400 px-3 py-1.5 rounded-lg border border-indigo-500/30 hover:bg-indigo-600 hover:text-white transition">
                            + Konu Ekle
                        </button>
                    </div>
                    <div id="topics-container" class="space-y-3">
                        <!-- Konu inputları buraya gelecek -->
                    </div>
                </div>
            </div>

            <div class="pt-6 mt-4 border-t border-white/10">
                <button id="save-course-btn" onclick="saveCourse()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition duration-300 flex items-center justify-center gap-2">
                    <span id="btn-text">Dersi Kaydet ve AI Özetini Hazırla</span>
                    <div id="btn-loader" class="hidden loader w-5 h-5 border-2 rounded-full"></div>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'studyflow-ai-v2';

        const GEMINI_API_KEY = "AIzaSyAjy45LZgWKZqRMrC6XEvMg0qRDu9KZqBM";

        let currentUser = null;
        let courses = [];
        let courseUnsubscribe = null;

        // Auth İşlemleri
        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                hideError();
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                showError("Giriş hatası: " + err.message);
            }
        };

        window.handleSignup = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                hideError();
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (err) {
                showError("Kayıt hatası: " + err.message);
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            location.reload();
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                loadCourses(user.uid);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('dashboard-screen').classList.add('hidden');
            }
            lucide.createIcons();
        });

        // Konu Field Yönetimi
        let topicIndex = 0;
        window.addTopicField = () => {
            const container = document.getElementById('topics-container');
            const div = document.createElement('div');
            div.className = "p-4 bg-white/5 rounded-xl border border-white/5 space-y-3 relative";
            div.id = `topic-field-${topicIndex}`;
            div.innerHTML = `
                <button onclick="removeTopicField(${topicIndex})" class="absolute top-2 right-2 text-gray-500 hover:text-red-400"><i data-lucide="minus-circle" class="w-4 h-4"></i></button>
                <input type="text" placeholder="Konu Başlığı" class="topic-title w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm focus:outline-none focus:border-indigo-500">
                <input type="text" placeholder="YouTube Linki" class="topic-url w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm focus:outline-none focus:border-indigo-500">
            `;
            container.appendChild(div);
            lucide.createIcons();
            topicIndex++;
        };

        window.removeTopicField = (id) => {
            const el = document.getElementById(`topic-field-${id}`);
            if (el) el.remove();
        };

        // Veri Kaydetme ve AI
        async function getAICourseSummary(courseName, topics) {
            const topicListStr = topics.map(t => t.title).join(", ");
            const prompt = `Ders Adı: ${courseName}. İşlenen Konular: ${topicListStr}. 
            Lütfen bu konuları kapsayan, öğrencinin çalışırken yan sekmede görebileceği kapsamlı bir Türkçe ders özeti hazırla. 
            Madde madde anlat, önemli formülleri/kavramları vurgula.`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Özet oluşturulamadı.";
            } catch (e) {
                console.error("AI Error:", e);
                return "Yapay zeka şu an meşgul, ancak videolardan çalışmaya başlayabilirsin.";
            }
        }

        window.saveCourse = async () => {
            if (!currentUser) return;
            const courseName = document.getElementById('course-name').value;
            const topicEls = document.querySelectorAll('.topic-field'); // This won't work with my manual append, let's select inputs
            const topicTitles = document.querySelectorAll('.topic-title');
            const topicUrls = document.querySelectorAll('.topic-url');
            
            const topics = [];
            for(let i=0; i < topicTitles.length; i++) {
                if(topicTitles[i].value && topicUrls[i].value) {
                    topics.push({ title: topicTitles[i].value, url: topicUrls[i].value });
                }
            }

            if (!courseName || topics.length === 0) {
                alert("Lütfen ders adını girin ve en az bir konu ekleyin.");
                return;
            }

            const btn = document.getElementById('save-course-btn');
            btn.disabled = true;
            document.getElementById('btn-loader').classList.remove('hidden');
            document.getElementById('btn-text').textContent = "AI Analiz Ediyor...";

            const summary = await getAICourseSummary(courseName, topics);

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'courses'), {
                    name: courseName,
                    topics: topics,
                    aiSummary: summary,
                    createdAt: Date.now()
                });
                closeModal('add-course-modal');
                resetCourseForm();
            } catch (err) {
                console.error("Kayıt Hatası:", err);
            } finally {
                btn.disabled = false;
                document.getElementById('btn-loader').classList.add('hidden');
                document.getElementById('btn-text').textContent = "Dersi Kaydet ve AI Özetini Hazırla";
            }
        };

        function resetCourseForm() {
            document.getElementById('course-name').value = "";
            document.getElementById('topics-container').innerHTML = "";
            addTopicField(); // Default bir tane aç
        }

        // Dashboard Veri Yükleme
        function loadCourses(userId) {
            if (courseUnsubscribe) courseUnsubscribe();
            const q = collection(db, 'artifacts', appId, 'users', userId, 'courses');
            courseUnsubscribe = onSnapshot(q, (snapshot) => {
                courses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCourses();
            });
        }

        function renderCourses() {
            const list = document.getElementById('course-list');
            const noCourses = document.getElementById('no-courses');
            list.innerHTML = "";
            if (courses.length === 0) { noCourses.classList.remove('hidden'); return; }
            noCourses.classList.add('hidden');

            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = "glass rounded-2xl overflow-hidden shadow-lg border border-white/5 transition hover:border-indigo-500/30 p-6 flex flex-col justify-between";
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="font-bold text-xl leading-tight text-white">${course.name}</h4>
                            <button onclick="deleteCourse('${course.id}')" class="text-gray-600 hover:text-red-400 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">${course.topics.length} Konu Mevcut</p>
                        <div class="space-y-2 mb-6">
                            ${course.topics.slice(0, 3).map(t => `<div class="text-xs text-indigo-300 flex items-center gap-2"><i data-lucide="check-circle" class="w-3 h-3"></i> ${t.title}</div>`).join('')}
                            ${course.topics.length > 3 ? `<p class="text-[10px] text-gray-500 italic">+${course.topics.length - 3} konu daha</p>` : ''}
                        </div>
                    </div>
                    <button onclick="startStudy('${course.id}')" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-semibold transition shadow-lg shadow-indigo-900/20">
                        Ders Çalışmaya Başla
                    </button>
                `;
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        window.deleteCourse = async (id) => {
            if (confirm("Bu dersi silmek istiyor musunuz?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'courses', id));
            }
        };

        // Study Mode
        window.startStudy = (courseId) => {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;

            document.getElementById('study-course-title').textContent = course.name;
            document.getElementById('ai-summary-text').textContent = course.aiSummary;
            
            // Navigasyon butonları
            const nav = document.getElementById('topic-nav');
            nav.innerHTML = "";
            course.topics.forEach((topic, idx) => {
                const btn = document.createElement('button');
                btn.className = "px-4 py-2 whitespace-nowrap bg-white/5 border border-white/10 rounded-lg text-sm text-gray-400 hover:bg-indigo-600 hover:text-white transition";
                btn.textContent = `${idx + 1}. ${topic.title}`;
                btn.onclick = () => loadTopic(topic);
                nav.appendChild(btn);
            });

            // İlk konuyu yükle
            loadTopic(course.topics[0]);

            document.getElementById('study-mode').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        };

        function loadTopic(topic) {
            const videoId = extractVideoId(topic.url);
            document.getElementById('study-topic-title').textContent = topic.title;
            document.getElementById('video-container').innerHTML = `
                <iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            `;
        }

        function extractVideoId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        window.exitStudyMode = () => {
            document.getElementById('study-mode').classList.add('hidden');
            document.getElementById('video-container').innerHTML = "";
            document.body.style.overflow = 'auto';
        };

        // Helpers
        window.showModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            if(id === 'add-course-modal' && document.getElementById('topics-container').innerHTML === "") {
                addTopicField();
            }
        };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        function showError(msg) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = msg;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('auth-error').classList.add('hidden');
        }

    </script>
</body>
</html>
